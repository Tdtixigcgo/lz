<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title id="page-title">ğŸ§§ LÃ¬ XÃ¬ Online</title>
  <link rel="stylesheet" href="../style.css"/>
  <style>
    #greeting-bar{display:none}
    #already-opened-banner{display:none}
  </style>
</head>
<body>
<div class="bg-layer"></div>
<div class="bg-pattern"></div>

<!-- Loading -->
<div id="loading-screen">
  <div class="ld-logo">ğŸ§§</div>
  <p class="ld-title" id="ld-title">LÃ¬ XÃ¬ Online</p>
  <p class="ld-msg" id="ld-msg">Äang káº¿t ná»‘i...</p>
  <div class="ld-bar"><div class="ld-fill"></div></div>
  <p class="ld-err" id="ld-err"></p>
</div>

<!-- Sync -->
<div id="sync-indicator">
  <span class="sync-dot" id="sync-dot"></span>
  <span class="sync-lbl" id="sync-lbl">Káº¿t ná»‘i</span>
</div>

<!-- Name Modal -->
<div id="name-modal">
  <div class="name-card">
    <span class="nc-emoji" id="nc-emoji">ğŸ§§</span>
    <h1 class="nc-title" id="nc-title">LÃ¬ XÃ¬ Táº¿t 2025</h1>
    <p class="nc-sub" id="nc-sub">ChÃºc má»«ng nÄƒm má»›i</p>
    <p class="nc-host" id="nc-host" style="display:none"></p>
    <p class="nc-label">Nháº­p tÃªn cá»§a báº¡n Ä‘á»ƒ báº¯t Ä‘áº§u</p>
    <input class="nc-input" id="nm-input" type="text" placeholder="TÃªn cá»§a báº¡n..." maxlength="40" autocomplete="off"/>
    <p class="nc-err" id="nm-err"></p>
    <button class="nc-btn" id="nm-btn">ğŸŠ Bá»‘c lÃ¬ xÃ¬ thÃ´i!</button>
  </div>
</div>

<!-- Game Closed -->
<div id="game-closed-overlay">
  <div class="gc-card">
    <span class="gc-icon">ğŸ”’</span>
    <h2 class="gc-title" id="gc-title">Game Ä‘Ã£ Ä‘Ã³ng</h2>
    <p class="gc-msg" id="gc-msg">PhÃ²ng lÃ¬ xÃ¬ nÃ y hiá»‡n khÃ´ng má»Ÿ. Vui lÃ²ng liÃªn há»‡ chá»§ phÃ²ng!</p>
    <div style="margin-top:24px"><a href="/" style="color:rgba(255,215,0,.6);font-size:.85rem;text-decoration:none">â† Vá» trang chá»§</a></div>
  </div>
</div>

<!-- Already Opened -->
<div id="already-opened-banner">
  <span>ğŸ§§</span>
  <span id="banner-text">Báº¡n Ä‘Ã£ bá»‘c rá»“i!</span>
</div>

<div class="page-wrapper">
  <div class="container">
    <header class="site-header">
      <div class="header-ornament">ğŸ® âœ¦ ğŸ§§ âœ¦ ğŸ®</div>
      <h1 class="site-title" id="site-title">LÃ¬ XÃ¬ Táº¿t 2025</h1>
      <p class="site-subtitle" id="site-subtitle">ChÃºc má»«ng nÄƒm má»›i</p>
      <div class="host-badge" id="host-badge" style="display:none">
        <span>ğŸ‘¤ Chá»§ phÃ²ng:</span><strong id="host-name-display"></strong>
      </div>
      <div class="gold-divider"></div>
    </header>

    <div id="greeting-bar" style="text-align:center;margin-bottom:18px;display:none">
      <span class="greeting-text">Xin chÃ o <strong id="greeting-name"></strong> ğŸŒ¸ Â· Bá»‘c má»™t Ã´ may máº¯n nÃ o!</span>
    </div>

    <div class="stats-bar" role="status">
      <div class="stat-chip"><span class="stat-icon">ğŸ§§</span>ÄÃ£ bá»‘c: <span class="stat-val" id="stat-opened">0</span>/<span class="stat-val" id="stat-total">â€”</span></div>
      <div class="stat-chip"><span class="stat-icon">ğŸ’°</span>Tá»•ng: <span class="stat-val" id="stat-amount">0</span>k</div>
      <div class="stat-chip" id="stat-players-chip"><span class="stat-icon">ğŸ‘¥</span>NgÆ°á»i chÆ¡i: <span class="stat-val" id="stat-players">0</span></div>
    </div>

    <section aria-label="Phong bÃ¬ lÃ¬ xÃ¬">
      <p class="section-label" id="section-label">âœ¦ Chá»n má»™t phong bÃ¬ may máº¯n âœ¦</p>
      <div class="envelope-grid" id="envelope-grid" role="list"></div>
    </section>

    <footer class="site-footer">
      <p id="footer-text">âœ¦ ChÃºc má»«ng nÄƒm má»›i Â· An khang thá»‹nh vÆ°á»£ng âœ¦</p>
      <p style="margin-top:8px"><a href="/" style="color:rgba(255,215,0,.2);font-size:.7rem;text-decoration:none">â† Táº¡o phÃ²ng lÃ¬ xÃ¬ cá»§a riÃªng báº¡n</a></p>
    </footer>
  </div>
</div>

<!-- Reveal Modal -->
<div class="reveal-overlay" id="reveal-overlay">
  <div class="reveal-card">
    <span class="reveal-big-emoji" id="reveal-emoji">ğŸ§§</span>
    <p class="reveal-label">LÃ¬ XÃ¬ Cá»§a Báº¡n</p>
    <div class="reveal-amount" id="reveal-amount">0</div>
    <p class="reveal-unit">nghÃ¬n Ä‘á»“ng</p>
    <p class="reveal-message" id="reveal-message"></p>
    <button class="reveal-close-btn" id="reveal-close-btn">Cáº£m Æ¡n! ğŸŒ¸</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="../config.js"></script>
<script>
'use strict';

// Get room ID from URL: /room/:roomId
const ROOM_ID = location.pathname.split('/').filter(Boolean)[1] || '';
const SESSION_KEY = 'lixi_name_' + ROOM_ID;

let CFG = {
  confettiCount: 80, showPlayerCount: true,
  messages: { low:['NÄƒm má»›i váº¡n sá»± nhÆ° Ã½! ğŸŒ¸'], mid:['PhÃº quÃ½ vinh hoa! ğŸ‹'], high:['Äáº¡i cÃ¡t Ä‘áº¡i lá»£i! ğŸ’°'] }
};
const state = { envelopes:[], totalOpened:0, totalAmount:0, sb:null, playerName:'', myEnvId:null, hasOpened:false, playerCount:0 };

const $ = id => document.getElementById(id);
const grid = $('envelope-grid');

function setLoading(msg) { $('ld-msg').textContent = msg; }
function setErr(msg) { const e=$('ld-err'); e.textContent=msg; e.style.display='block'; }
function hideLoading() { const el=$('loading-screen'); el.classList.add('hidden'); setTimeout(()=>el.style.display='none',600); }
function setSynced(ok) { $('sync-dot').className='sync-dot'+(ok?' live':''); $('sync-lbl').textContent=ok?'Äang Ä‘á»“ng bá»™':'Máº¥t káº¿t ná»‘i'; }

function getEmoji(v) { if(v>=100)return'ğŸŠ';if(v>=50)return'ğŸ’°';if(v>=20)return'ğŸ®';if(v>=10)return'ğŸ§§';return'ğŸŒ¸'; }
function getMessage(v) {
  const msgs = v<=5?CFG.messages.low:v<=15?CFG.messages.mid:CFG.messages.high;
  return msgs[Math.floor(Math.random()*msgs.length)];
}
function shuffle(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b;}

async function boot() {
  if (!ROOM_ID) { setErr('âŒ KhÃ´ng tÃ¬m tháº¥y phÃ²ng. Kiá»ƒm tra láº¡i link!'); return; }

  setLoading('Äang káº¿t ná»‘i...');
  state.sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  setLoading('Äang táº£i phÃ²ng...');
  const { data: room, error: re } = await state.sb.from('rooms').select('*').eq('id', ROOM_ID).single();
  if (re || !room) { setErr('âŒ KhÃ´ng tÃ¬m tháº¥y phÃ²ng lÃ¬ xÃ¬ nÃ y!'); return; }

  // Apply room config
  document.title = 'ğŸ§§ ' + room.title;
  $('page-title').textContent = 'ğŸ§§ ' + room.title;
  $('site-title').textContent = room.title;
  $('site-subtitle').textContent = room.subtitle || '';
  $('nc-title').textContent = room.title;
  $('nc-sub').textContent = room.subtitle || '';
  $('nc-emoji').textContent = room.emoji || 'ğŸ§§';
  if (room.host_name) {
    $('host-badge').style.display = 'flex';
    $('host-name-display').textContent = room.host_name;
    $('nc-host').style.display = 'block';
    $('nc-host').innerHTML = `PhÃ²ng cá»§a <strong>${escHtml(room.host_name)}</strong>`;
  }

  if (room.config) {
    Object.assign(CFG, room.config);
    if (room.config.messages) CFG.messages = { ...CFG.messages, ...room.config.messages };
  }
  if (!room.is_open) {
    hideLoading();
    $('game-closed-overlay').classList.add('show');
    return;
  }

  setLoading('Äang táº£i phong bÃ¬...');
  const { data: envs, error: ee } = await state.sb.from('envelopes').select('*').eq('room_id', ROOM_ID).order('position');
  if (ee) { setErr('âŒ ' + ee.message); return; }

  state.envelopes   = envs.map(r => ({ id:r.position+1, displayValue:r.display_value, realValue:r.real_value, isSpecial:r.is_special, opened:r.opened, openedAt:r.opened_at, openedBy:r.opened_by||'', _dbId:r.id }));
  state.totalOpened = state.envelopes.filter(e=>e.opened).length;
  state.totalAmount = state.envelopes.filter(e=>e.opened).reduce((s,e)=>s+e.displayValue,0);

  const { count } = await state.sb.from('envelopes').select('id',{head:true,count:'exact'}).eq('room_id',ROOM_ID).eq('opened',true);
  state.playerCount = count || 0;

  subscribeRealtime();
  setSynced(true);
  hideLoading();
  updateStats();
  renderGrid();
  spawnPetals();

  if (!CFG.showPlayerCount) $('stat-players-chip').style.display = 'none';

  // Check session
  const saved = sessionStorage.getItem(SESSION_KEY);
  if (saved) {
    state.playerName = saved;
    showGreeting(saved);
    const mine = state.envelopes.find(e=>e.opened && e.openedBy===saved);
    if (mine) { state.hasOpened=true; state.myEnvId=mine._dbId; showBanner(saved, mine.displayValue); }
    $('name-modal').classList.add('hidden');
  }
}

function subscribeRealtime() {
  state.sb.channel('room-'+ROOM_ID)
    .on('postgres_changes', { event:'UPDATE', schema:'public', table:'envelopes', filter:`room_id=eq.${ROOM_ID}` }, (p) => {
      const r=p.new; if(!r.opened) return;
      const env=state.envelopes.find(e=>e._dbId===r.id);
      if(!env||env.opened) return;
      env.opened=true; env.openedAt=r.opened_at; env.openedBy=r.opened_by||'';
      state.totalOpened++; state.totalAmount+=env.displayValue; state.playerCount++;
      const card=grid.querySelector(`[data-id="${env.id}"]`);
      if(card&&!card.classList.contains('opened')) { card.classList.add('opened'); card._handler&&card.removeEventListener('click',card._handler); }
      updateStats();
    })
    .on('postgres_changes', { event:'UPDATE', schema:'public', table:'rooms', filter:`id=eq.${ROOM_ID}` }, (p) => {
      if (!p.new.is_open) { $('game-closed-overlay').classList.add('show'); }
    })
    .subscribe(s => setSynced(s==='SUBSCRIBED'));
}

function renderGrid() {
  grid.innerHTML = '';
  state.envelopes.forEach((env, idx) => {
    const card = document.createElement('div');
    card.className = 'envelope-card' + (env.opened?' opened':'');
    card.dataset.id = env.id;
    card.style.animationDelay = `${idx * 0.035}s`;
    card.setAttribute('role','listitem');
    card.innerHTML = `
      <div class="env-front">
        <span class="env-icon">ğŸ§§</span>
        <div class="amount-reveal">
          <span class="amount-emoji">${getEmoji(env.displayValue)}</span>
          <span class="amount-number">${env.displayValue}k</span>
          <span class="amount-unit">nghÃ¬n Ä‘á»“ng</span>
          ${env.openedBy?`<span class="amount-by">${escHtml(env.openedBy)}</span>`:''}
        </div>
        <span class="env-num">#${String(env.id).padStart(2,'0')}</span>
        <div class="env-shimmer"></div>
      </div>`;
    if (!env.opened) { const h=()=>handleClick(card,env); card._handler=h; card.addEventListener('click',h); }
    grid.appendChild(card);
  });
}

function handleClick(card, env) {
  if (env.opened) return;
  if (!state.playerName) { $('name-modal').classList.remove('hidden'); $('nm-input').focus(); return; }
  if (state.hasOpened) { flashBanner(); return; }
  openEnvelope(card, env);
}

async function openEnvelope(card, env) {
  env.opened=true; env.openedBy=state.playerName;
  state.hasOpened=true; state.myEnvId=env._dbId;
  state.totalOpened++; state.totalAmount+=env.displayValue; state.playerCount++;
  card.classList.add('opened');
  card._handler&&card.removeEventListener('click',card._handler);
  // Show name
  const ar=card.querySelector('.amount-reveal');
  if(ar&&!ar.querySelector('.amount-by')){const s=document.createElement('span');s.className='amount-by';s.textContent=state.playerName;ar.appendChild(s);}
  updateStats();

  try {
    const now=new Date().toISOString();
    env.openedAt=now;
    await state.sb.from('envelopes').update({opened:true,opened_at:now,opened_by:state.playerName}).eq('id',env._dbId);
    await state.sb.from('envelopes').update({}).eq('id',env._dbId); // trigger realtime
    // Log event
    await state.sb.from('events').insert({room_id:ROOM_ID,envelope_id:env._dbId,display_value:env.displayValue,real_value:env.realValue,is_special:env.isSpecial,player_name:state.playerName,created_at:now});
    // Update room opened_count
    await state.sb.from('rooms').update({opened_count:state.totalOpened}).eq('id',ROOM_ID);
  } catch(e) {
    // rollback
    env.opened=false; env.openedBy=''; state.hasOpened=false; state.myEnvId=null;
    state.totalOpened--; state.totalAmount-=env.displayValue; state.playerCount--;
    card.classList.remove('opened');
    const h=()=>handleClick(card,env); card._handler=h; card.addEventListener('click',h);
    updateStats(); alert('âš  Lá»—i lÆ°u dá»¯ liá»‡u. Thá»­ láº¡i!'); return;
  }

  showBanner(state.playerName, env.displayValue);
  setTimeout(()=>showReveal(env), 350);
}

function showReveal(env) {
  $('reveal-emoji').textContent = getEmoji(env.displayValue);
  $('reveal-amount').textContent = env.displayValue;
  $('reveal-message').textContent = getMessage(env.displayValue);
  $('reveal-overlay').classList.add('show');
  spawnConfetti();
  $('reveal-close-btn').onclick = () => {
    $('reveal-overlay').classList.remove('show');
    if (env.isSpecial) showAdminHint(env.realValue);
  };
}

function showAdminHint(rv) {
  $('admin-hint')?.remove();
  const d=document.createElement('div'); d.id='admin-hint';
  d.innerHTML=`<div class="admin-hint-card"><span class="hint-icon">ğŸ”</span><p class="hint-title">LÃ¬ XÃ¬ Äáº·c Biá»‡t!</p><p class="hint-sub">Má»‡nh giÃ¡ thá»±c: <strong>${rv}k</strong> ğŸ†</p><p class="hint-desc">LiÃªn há»‡ chá»§ phÃ²ng Ä‘á»ƒ xÃ¡c nháº­n vÃ  nháº­n thÆ°á»Ÿng.</p><div class="hint-btns"><button class="hint-btn-outline" onclick="document.getElementById('admin-hint').remove()">ÄÃ³ng</button></div></div>`;
  document.body.appendChild(d);
}

function updateStats() {
  $('stat-opened').textContent = state.totalOpened;
  $('stat-total').textContent  = state.envelopes.length;
  $('stat-amount').textContent = state.totalAmount;
  $('stat-players').textContent = state.playerCount;
}

function showGreeting(name) { $('greeting-bar').style.display='block'; $('greeting-name').textContent=name; }
function showBanner(name, val) { $('banner-text').textContent=`Báº¡n (${name}) Ä‘Ã£ bá»‘c Ä‘Æ°á»£c ${val}k! ğŸ‰`; const b=$('already-opened-banner'); b.style.display='flex'; b.classList.add('show'); }
function flashBanner() { const b=$('already-opened-banner'); b.classList.remove('show'); requestAnimationFrame(()=>b.classList.add('show')); }
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

// Name modal
$('nm-input').addEventListener('keydown', e=>{ if(e.key==='Enter') $('nm-btn').click(); });
$('nm-btn').addEventListener('click', () => {
  const name = $('nm-input').value.trim();
  if(!name||name.length<2){$('nm-err').textContent='âš  Nháº­p tÃªn Ã­t nháº¥t 2 kÃ½ tá»±';return;}
  const existing=state.envelopes.find(e=>e.opened&&e.openedBy===name);
  if(existing){
    state.playerName=name; state.hasOpened=true; state.myEnvId=existing._dbId;
    sessionStorage.setItem(SESSION_KEY,name);
    $('nm-err').textContent=''; $('nm-input').value='';
    $('name-modal').classList.add('hidden');
    showGreeting(name); showBanner(name,existing.displayValue);
    return;
  }
  state.playerName=name;
  sessionStorage.setItem(SESSION_KEY,name);
  $('name-modal').classList.add('hidden');
  showGreeting(name);
});

// Confetti
const CC=['#ffd700','#ff6b6b','#ff4500','#ffcd3c','#c0392b','#f1c40f','#e8d5b7'];
function spawnConfetti(){
  const count=CFG.confettiCount||80;
  const f=document.createDocumentFragment();
  for(let i=0;i<count;i++){
    const el=document.createElement('div'); el.className='confetti';
    el.style.cssText=`left:${20+Math.random()*60}%;top:${20+Math.random()*30}%;background:${CC[Math.floor(Math.random()*CC.length)]};width:${6+Math.random()*8}px;height:${10+Math.random()*12}px;--drift:${(Math.random()-.5)*400}px;--dur:${2.5+Math.random()*2}s;--delay:${Math.random()*.5}s;border-radius:${Math.random()>.5?'50%':'2px'}`;
    f.appendChild(el); setTimeout(()=>el.remove(),5000);
  }
  document.body.appendChild(f);
}
function spawnPetals(){
  const P=['ğŸŒ¸','ğŸŒº','ğŸ€','â­','âœ¨','ğŸ’«'];
  for(let i=0;i<18;i++){
    const el=document.createElement('div'); el.className='petal';
    el.textContent=P[Math.floor(Math.random()*P.length)];
    el.style.cssText=`left:${Math.random()*100}%;animation-duration:${8+Math.random()*12}s;animation-delay:${Math.random()*10}s;font-size:${.7+Math.random()*.9}rem;opacity:0`;
    document.body.appendChild(el);
  }
}

document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
